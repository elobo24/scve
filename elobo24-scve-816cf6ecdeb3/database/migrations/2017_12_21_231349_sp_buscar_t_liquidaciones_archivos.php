<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class SpBuscarTLiquidacionesArchivos extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
      $command = "CREATE OR REPLACE FUNCTION sp_buscar_t_liquidaciones_archivos(num_liquidaciones integer DEFAULT 0)
        RETURNS SETOF t_liquidaciones_archivos AS
      \$BODY\$DECLARE
      					sql varchar;
      					parm varchar;
      					reg t_liquidaciones_archivos%ROWTYPE;
      					total_rows integer;
      				BEGIN
      					total_rows :=0;
      				RAISE INFO ' CONSULTA TABLE t_liquidaciones_archivos - %','';
      					if num_liquidaciones <> 0 then
      						parm := ' where num_liquidaciones = ' || num_liquidaciones;
      					else parm := '';
      					end if;
      					sql := '

      SELECT id,
      							fecha_hora_ejecucion,
      							critico_ejecucion,
      							estatus, num_liquidaciones
      							FROM
      							t_liquidaciones_archivos'|| parm;
      					for reg in execute sql loop return next reg; end loop; return;
      				EXCEPTION
      				WHEN NO_DATA_FOUND THEN RAISE EXCEPTION
      					'CONSULTA TABLA t_liquidaciones_archivos % not found','';
      				 END; \$BODY\$
        LANGUAGE plpgsql VOLATILE
        COST 100
        ROWS 1000;
      ALTER FUNCTION sp_buscar_t_liquidaciones_archivos(integer)
        OWNER TO forge;
      ";
       DB::connection()->getPdo()->exec($command);
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
       $command = "DROP FUNCTION sp_buscar_t_liquidaciones_archivos(integer)";
       DB::connection()->getPdo()->exec($command);
    }
}
