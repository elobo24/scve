<?php

namespace App\Http\Controllers\Backend\Seguridad\Reportes;

use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use Session;
use DB;

class HistoricoCambiosController extends Controller
{
    public function getIndex()
    {
        $logs = DB::table('audits')
        ->where('url', 'NOT LIKE', '%login')
        ->where('url', 'NOT LIKE', '%logout')
        ->where('old_values', 'NOT LIKE', '%remember_token%')
        ->where('new_values', 'NOT LIKE', '%remember_token%')
        ->leftJoin('users', 'users.id', '=', 'audits.user_id')
        ->select('audits.*', 'users.name as username', 'users.email as user_email')
        ->orderBy('audits.id', 'DESC')
        ->paginate(10);

        for($x = 0; $x < count($logs); $x++) {

            /** Cambiamos el evento por su contraparte en español */
            if($logs[$x]->event == 'created') {
                $logs[$x]->event = 'Creación';
            } elseif($logs[$x]->event == 'updated') {
                $logs[$x]->event = 'Actualización';
            } elseif($logs[$x]->event == 'deleted') {
                $logs[$x]->event = 'Eliminación';
            }

        }

        //dd($logs);

        return view('backend.seguridad.reportes.historico_cambios.index')
        ->with('logs', $logs);
    }

    public function show($id)
    {

        $log = DB::table('audits')
        ->where('audits.id', $id)
        ->leftJoin('users', 'users.id', '=', 'audits.user_id')
        ->select('audits.*', 'users.name as username', 'users.email as user_email')
        ->first();

        /** Cambiamos el evento por su contraparte en español */
        if($log->event == 'created') {
            $log->event = 'Creación';
        } elseif($log->event == 'updated') {
            $log->event = 'Actualización';
        } elseif($log->event == 'deleted') {
            $log->event = 'Eliminación';
        }

        //dd($log);

        return view('backend.seguridad.reportes.historico_cambios.show')
        ->with('log', $log);
    }

}
