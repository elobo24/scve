<?php

namespace App\Http\Controllers\Backend\ControlVisitas\Egresos;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Control_Visitas\Equipajes;
use App\Models\Control_Visitas\Visitas;
use App\Models\Control_Visitas\Visitantes;
use App\Models\Configuracion\Empresas;
use App\Models\Configuracion\Bienes;
use App\Http\Requests\Backend\Control_Visitas\Equipos\EquipajesUpdateRequest;
use Session;
use DB;
use Illuminate\Database\Connection;
use Yajra\Datatables\Facades\Datatables;
use Jenssegers\Date\Date;

class EquiposController extends Controller
{
  public function __construct()
  {
    Date::setLocale('es');
  }
  public function getIndex()
  {
    $query = "SELECT * FROM sp_control_visitas_egresos_equipos()";
    $EgresosEquipos = DB::select($query);

    return View('backend.control_visitas.egresos.equipos.index')
    ->with('EgresosEquipos', $EgresosEquipos);
  }
  public function create()
  {
    $equipo = [
        '' => '-- SELECCIONE --',
    ];

    return View('backend.control_visitas.egresos.equipos.create')
    ->with('equipo', $equipo);
  }
  public function edit($id)
  {
    $EgresosEquiposDetalle = Equipajes::select('t_equipajes.id','t_visitantes.cedula',DB::raw("CONCAT(t_visitantes.nombre,' ',t_visitantes.apellido) AS nombre_completo"),'t_empresas.nombre',DB::raw("('t_bienes.nombre')AS nombre_equipo"),'t_equipajes.serial','t_equipajes.marca','t_equipajes.modelo','t_equipajes.hora_entrada')
    ->join('t_visitas','t_equipajes.visita_id','=','t_visitas.id')
    ->join('t_visitantes','t_visitas.visitante_id','=','t_visitantes.id')
    ->join('t_empresas','t_visitas.empresa_id','=','t_empresas.id')
    ->join('t_bienes','t_equipajes.bien_id','=','t_bienes.id')
    ->where('t_equipajes.id','=',$id)
    ->first();

    return view('backend.control_visitas.egresos.equipos.edit')
    ->with('EgresosEquiposDetalle', $EgresosEquiposDetalle);
  }
  public function update(EquipajesUpdateRequest $request, $id)
  {

    $egreso = Equipajes::find($id);
    $egreso->salida = '1';
    $egreso->hora_salida = Date::now();
    $egreso->observaciones = $request->observacion;
    $egreso->save();

    notify()->flash('Equipo Egresado del Edificio', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('EquiposEgresos');
  }
}
