<?php

namespace App\Http\Controllers\Backend\ControlVisitas\Egresos;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Configuracion\Empresas;
use App\Models\Control_Visitas\Visitantes;
use App\Models\Control_Visitas\Visitas;
use App\Http\Requests\Backend\Control_Visitas\Personas\PersonasUpdateRequest;
use Session;
use DB;
use Illuminate\Database\Connection;
use Yajra\Datatables\Facades\Datatables;
use Jenssegers\Date\Date;

class PersonasController extends Controller
{
  public function __construct()
  {
    Date::setLocale('es');
  }
  public function getIndex()
  {
    $query = "SELECT * FROM sp_control_visitas_egresos_personas()";
    $EgresosPersonas = DB::select($query);

    return View('backend.control_visitas.egresos.personas.index')
    ->with('EgresosPersonas', $EgresosPersonas);
  }
  public function edit($id)
  {
    $EgresosPersonasDetalle = Visitantes::select('t_visitas.id','t_visitantes.cedula',DB::raw("CONCAT(t_visitantes.nombre,' ',t_visitantes.apellido) AS nombre_completo"),'t_visitas.empresa_origen','t_empresas.nombre','t_visitas.entrada')
    ->join('t_visitas','t_visitas.visitante_id','=','t_visitantes.id')
    ->join('t_empresas','t_visitas.empresa_id','=','t_empresas.id')
    ->where('t_visitas.id','=',$id)
    ->first();

    return view('backend.control_visitas.egresos.personas.edit')
    ->with('EgresosPersonasDetalle', $EgresosPersonasDetalle);
  }
  public function update(PersonasUpdateRequest $request, $id)
  {

    $egreso = Visitas::find($id);
    $egreso->salida = Date::now();
    $egreso->save();

    notify()->flash('Persona Egresada de Edificio', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('PersonasEgresos');
  }
}
