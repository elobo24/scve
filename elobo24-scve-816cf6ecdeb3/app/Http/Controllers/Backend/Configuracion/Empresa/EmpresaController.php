<?php

namespace App\Http\Controllers\Backend\Configuracion\Empresa;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Configuracion\Pisos;
use App\Models\Configuracion\Oficinas;
use App\Models\Configuracion\Empresas;
use App\Http\Requests\Backend\Configuracion\Empresa\EmpresaCreateRequest;
use App\Http\Requests\Backend\Configuracion\Empresa\EmpresaUpdateRequest;
use Session;
use DB;
use Illuminate\Database\Connection;
use Yajra\Datatables\Facades\Datatables;
use Input;
use Response;

class EmpresaController extends Controller
{
  public function getIndex(Request $request)
  {
    $empresas = Empresas::select('t_empresas.*','t_oficinas.nombre as oficina','t_pisos.nombre as piso')
    ->join('t_oficinas','t_oficinas.id','=','t_empresas.oficina_id')
    ->join('t_pisos','t_pisos.id','=','t_oficinas.piso_id')
    ->get();

    return view('backend.configuracion.empresas.index')
    ->with('empresas', $empresas);
  }

  public function create()
  {
    $pisos = Pisos::select('id', 'nombre')
    ->where('estatus','ACTIVO')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('Seleccione Piso', 0);

    return View('backend.configuracion.empresas.create')->with('pisos', $pisos);
  }

  public function store(EmpresaCreateRequest $request)
  {
    // Oficina
    $empresa = new Empresas();
    $empresa->oficina_id = $request->input('oficina_id');
    $empresa->nombre = $request->input('nombre');
    $empresa->estatus = $request->input('estatus');
    $result = $empresa->save();

    notify()->flash('Empresa Registrado', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Empresa');
  }

  public function show($id)
  {
    $empresa = Empresas::FindOrFail($id);
    return view('backend.configuracion.empresas.show')->with('empresa', $empresa);
  }

  public function edit($id)
  {
    // Crear lista de pisos
    $pisos = Pisos::select('id', 'nombre')
    ->where('estatus','ACTIVO')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('Seleccione Piso', 0);

    // Buscar empresa por el identificador
    $empresa = Empresas::find($id);

    // Buscar oficina por el identificador
    $oficina = Oficinas::find($empresa->oficina_id);

    return view('backend.configuracion.empresas.edit')
    ->with('pisos', $pisos)
    ->with('piso', $oficina->piso_id)
    ->with('empresa', $empresa);
  }

  public function update(EmpresaUpdateRequest $request, $id)
  {
    $empresa = Empresas::FindOrFail($id);
    $input = $request->all();  /*Guardamos toda la información que se esta enviando*/
    $result = $empresa->fill($input)->save(); /*Se guarda la información*/

    notify()->flash('Empresa Actualizada', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Empresa');
  }

  public function destroy($id)
  {
    $empresa = Empresas::FindOrFail($id);
    $result = $empresa->delete();

    if ($result)
    {
      return response()->json(['success'=>'true']);
    }
    else
    {
      return response()->json(['success'=> 'false']);
    }
  }

  public function getOficinas($id) {

    $oficinas = Oficinas::select('id', 'nombre')
    ->where('piso_id',$id)
    ->orderBy('nombre', 'asc')
    ->get();

    return response()->json($oficinas);
  }
}
