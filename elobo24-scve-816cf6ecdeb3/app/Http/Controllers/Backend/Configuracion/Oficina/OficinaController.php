<?php

namespace App\Http\Controllers\Backend\Configuracion\Oficina;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Configuracion\Pisos;
use App\Models\Configuracion\Oficinas;
use App\Http\Requests\Backend\Configuracion\Oficina\OficinaCreateRequest;
use App\Http\Requests\Backend\Configuracion\Oficina\OficinaUpdateRequest;
use Session;
use DB;
use Illuminate\Database\Connection;
use Yajra\Datatables\Facades\Datatables;
use Input;
use Response;

class OficinaController extends Controller
{
  public function getIndex(Request $request)
  {
    $oficinas = Oficinas::select('t_oficinas.*','t_pisos.nombre as piso')
    ->join('t_pisos','t_pisos.id','=','t_oficinas.piso_id')
    ->get();

    return view('backend.configuracion.oficinas.index')
    ->with('oficinas', $oficinas);
  }

  public function create()
  {
    $pisos = Pisos::select('id', 'nombre')
    ->where('estatus','ACTIVO')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('Seleccione Piso', 0);

    return View('backend.configuracion.oficinas.create')->with('pisos', $pisos);
  }

  public function store(OficinaCreateRequest $request)
  {
    // Oficina
    $oficina = new Oficinas();
    $oficina->piso_id = $request->input('piso_id');
    $oficina->nombre = $request->input('nombre');
    $oficina->estatus = $request->input('estatus');
    $result = $oficina->save();

    notify()->flash('Oficina Registrado', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Oficina');
  }

  public function show($id)
  {
    $oficina = Oficinas::FindOrFail($id);
    return view('backend.configuracion.oficinas.show')->with('oficina', $oficina);
  }

  public function edit($id)
  {
    $pisos = Pisos::select('id', 'nombre')
    ->where('estatus','ACTIVO')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('Seleccione Piso', 0);

    $oficina = Oficinas::find($id);

    return view('backend.configuracion.oficinas.edit')
    ->with('pisos', $pisos)
    ->with('oficina', $oficina);
  }

  public function update(OficinaUpdateRequest $request, $id)
  {
    $oficina = Oficinas::FindOrFail($id);
    $input = $request->all();  /*Guardamos toda la informaciÃ³n que se esta enviando*/
    $result = $oficina->fill($input)->save(); /*Se guarda la informaciÃ³n*/

    notify()->flash('Oficina Actualizada', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Oficina');
  }

  public function destroy($id)
  {
    $oficina = Oficinas::FindOrFail($id);
    $result = $oficina->delete();

    if ($result)
    {
      return response()->json(['success'=>'true']);
    }
    else
    {
      return response()->json(['success'=> 'false']);
    }
  }
}
