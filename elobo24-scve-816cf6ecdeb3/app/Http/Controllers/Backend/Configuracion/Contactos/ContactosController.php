<?php

namespace App\Http\Controllers\Backend\Configuracion\Contactos;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Configuracion\Contactos;
use App\Models\Configuracion\Empresas;
use App\Models\Configuracion\Pisos;
use App\Models\Configuracion\Oficinas;
use App\Http\Requests\Backend\Configuracion\Contactos\ContactosCreateRequest;
use App\Http\Requests\Backend\Configuracion\Contactos\ContactosUpdateRequest;
use Session;
use DB;
use Illuminate\Database\Connection;
use Yajra\Datatables\Facades\Datatables;
use Jenssegers\Date\Date;
use Input;
use Response;

class ContactosController extends Controller
{
  public function __construct()
  {
    Date::setLocale('es');
  }
  public function getIndex(Request $request)
  {
    $contactos = Contactos::select('t_contactos.id',DB::raw("CONCAT(t_contactos.nombre,' ',t_contactos.apellido) AS nombre_completo"),'t_contactos.telefono1','t_contactos.telefono2',DB::raw("(t_empresas.nombre) AS nombre_empresa"),DB::raw("(t_oficinas.nombre) AS nombre_oficina"),DB::raw("(t_pisos.nombre) AS nombre_piso"))
    ->join('t_empresas','t_contactos.empresa_id','=','t_empresas.id')
    ->join('t_oficinas','t_empresas.oficina_id','=','t_oficinas.id')
    ->join('t_pisos','t_oficinas.piso_id','=','t_pisos.id')
    ->get();

    return View('backend.configuracion.contactos.index')
    ->with('contactos', $contactos);
  }
  public function create()
  {
    $empresas = Empresas::select('id','nombre')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('-- SELECCIONE --', '');

    return View('backend.configuracion.contactos.create')
    ->with('empresas', $empresas);
  }
  public function store(ContactosCreateRequest $request)
  {
    $contactos = new Contactos();
    $contactos->empresa_id = $request->empresas;
    $contactos->nombre = $request->nombre;
    $contactos->apellido = $request->apellido;
    $contactos->telefono1 = $request->telefono1;
    $contactos->telefono2 = $request->telefono2;
    $result = $contactos->save();

    notify()->flash('Contacto Registrado', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Contactos');
  }
  public function edit($id)
  {
    $contacto = Contactos::find($id);

    $empresas = Empresas::select('id','nombre')
    ->orderBy('nombre', 'asc')
    ->lists('nombre','id')
    ->prepend('-- SELECCIONE --', '');

    return view('backend.configuracion.contactos.edit')
    ->with('contacto', $contacto)
    ->with('empresas', $empresas);
  }
  public function update(ContactosUpdateRequest $request, $id)
  {

    $contactos = Contactos::FindOrFail($id);
    $input = $request->all();  /*Guardamos toda la informaciÃ³n que se esta enviando*/
    $result = $contactos->fill($input)->save(); /*Se guarda la informaciÃ³n*/

    notify()->flash('Contacto Actualizado', 'success', [
      'timer' => 3000,
      'text' => ''
    ]);

    return redirect()->route('Contactos');
  }
  public function destroy($id)
  {
    $contactos = Contactos::FindOrFail($id);
    $result = $contactos->delete();

    if ($result)
    {
      return response()->json(['success'=>'true']);
    }
    else
    {
      return response()->json(['success'=> 'false']);
    }
  }
}
